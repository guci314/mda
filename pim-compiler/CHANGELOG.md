# 更新日志

所有重要的更改都将记录在此文件中。

## [3.1.0] - 2025-07-24

### 新增功能

#### 1. 应用启动验证（步骤4）
- 编译完成后自动启动生成的应用程序
- 支持自定义端口（默认8100，避免与开发环境冲突）
- 实时监控应用启动状态
- 启动失败时提供详细的错误日志

#### 2. REST API 端点测试（步骤5）
- 自动测试所有关键端点：
  - 根路径 `/`
  - API 文档 `/docs`
  - OpenAPI 规范
  - 资源列表端点（如 `/api/v1/patients/`）
- 显示测试结果统计（通过率百分比）
- 支持自定义 API 路径前缀

#### 3. 智能修复循环
- 应用启动失败时自动进入修复循环
- 最多尝试10次，避免无限循环
- 将错误信息和上下文传递给 Gemini CLI
- 智能识别并修复常见问题：
  - 模块导入错误
  - 属性缺失
  - 配置问题
  - 数据库连接错误

#### 4. 数据库配置优化
- 默认使用 SQLite 作为开发数据库
- PSM 生成时明确指定 SQLite 配置
- 修复了环境变量继承导致的数据库配置冲突
- 支持通过配置切换到 PostgreSQL

### 改进

#### 编译流程优化
- 更清晰的进度显示
- 更详细的错误信息
- 修复尝试历史记录
- 编译结果的结构化输出

#### 提示词优化
- 添加了常见问题修复指南
- 包含 FastAPI 配置知识
- 明确工作目录路径
- 数据库配置规范

### 修复

1. **环境变量继承问题**
   - 问题：子进程继承父进程的 DATABASE_URL 环境变量
   - 解决：在 PSM 生成时明确指定 SQLite 作为默认数据库

2. **应用启动错误处理**
   - 问题：`AttributeError: app not found in module main`
   - 解决：通过智能修复循环自动修正模块导入

3. **API 路径问题**
   - 问题：测试默认 `/openapi.json` 路径返回404
   - 解决：识别自定义 API 前缀，测试正确路径

### 技术细节

#### 新增的核心方法
- `_run_application()`: 管理应用启动和修复循环
- `_try_start_application()`: 尝试启动应用
- `_test_rest_endpoints()`: 测试 REST API 端点
- `_fix_startup_issues()`: 调用 Gemini CLI 修复启动问题

#### 新增的配置
- `CompilationResult.app_results`: 记录应用运行结果
- 支持修复历史记录
- 端口管理（默认8100）

### 示例

医院管理系统编译结果：
```
✅ 编译成功！
📁 生成的文件:
   总文件数: 131
   Python文件: 102

⏱️  编译时间: 6分28秒

🚀 应用运行:
   状态: ✅ 成功启动
   端口: 8100
   修复次数: 2

🌐 REST API 测试:
   测试端点数: 5
   通过端点数: 5
   成功率: 100%
```

## [3.0.0] - 2025-07-21

### 重大变更
- 完全基于 Gemini CLI 实现
- 移除所有其他 LLM 依赖
- 统一的 AI 代理架构

### 新增
- 纯 Gemini CLI 编译流程
- 实时文件生成进度显示
- 错误模式缓存机制
- 增量修复策略

### 性能优化
- 编译时间减少 50%+
- 内存使用优化
- 并行处理支持

## [2.0.0] - 2025-06-15

### 新增
- 多 LLM 支持
- 代码生成功能
- 自动测试框架

## [1.0.0] - 2025-05-01

### 初始发布
- 基础 PIM 到代码转换
- FastAPI 平台支持
- 简单的错误处理