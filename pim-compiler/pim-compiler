#!/usr/bin/env python3
"""
PIM Compiler CLI - å‘½ä»¤è¡Œå·¥å…·
ä½¿ç”¨ Gemini CLI å°† PIM è½¬æ¢ä¸ºå¯æ‰§è¡Œä»£ç 
"""
import argparse
import sys
import os
from pathlib import Path
from dotenv import load_dotenv

# æ·»åŠ srcåˆ°Pythonè·¯å¾„
script_dir = Path(__file__).parent
sys.path.insert(0, str(script_dir / "src"))

# å°è¯•åŠ è½½ç¯å¢ƒå˜é‡
def load_env():
    """æŒ‰ä¼˜å…ˆçº§åŠ è½½ç¯å¢ƒå˜é‡"""
    # 1. å½“å‰ç›®å½•çš„ .env
    local_env = Path.cwd() / ".env"
    if local_env.exists():
        load_dotenv(local_env)
        return local_env
    
    # 2. é¡¹ç›®æ ¹ç›®å½•çš„ .env
    project_env = script_dir.parent / ".env"
    if project_env.exists():
        load_dotenv(project_env)
        return project_env
    
    # 3. ç”¨æˆ·ç›®å½•çš„ .env
    home_env = Path.home() / ".env"
    if home_env.exists():
        load_dotenv(home_env)
        return home_env
    
    return None

from compiler.config import CompilerConfig
from compiler.compiler_factory import CompilerFactory
from utils.logger import get_logger

logger = get_logger(__name__)


def print_banner():
    """æ‰“å° CLI æ¨ªå¹…"""
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    PIM Compiler v3.0                      â•‘
â•‘         Platform Independent Model â†’ Executable Code      â•‘
â•‘                  Powered by Gemini CLI                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")


def print_result(result):
    """æ‰“å°ç¼–è¯‘ç»“æœ"""
    if result.success:
        print("\nâœ… ç¼–è¯‘æˆåŠŸï¼")
        print(f"\nğŸ“ ç”Ÿæˆçš„æ–‡ä»¶:")
        print(f"   - PSM æ–‡ä»¶: {result.psm_file}")
        print(f"   - ä»£ç ç›®å½•: {result.code_dir}")
        
        if result.statistics:
            print(f"\nğŸ“Š ç»Ÿè®¡ä¿¡æ¯:")
            print(f"   - æ€»æ–‡ä»¶æ•°: {result.statistics['total_files']}")
            print(f"   - Python æ–‡ä»¶: {result.statistics['python_files']}")
            print(f"   - PSM ç”Ÿæˆæ—¶é—´: {result.statistics['psm_generation_time']}ç§’")
            print(f"   - ä»£ç ç”Ÿæˆæ—¶é—´: {result.statistics['code_generation_time']}ç§’")
            print(f"   - æ€»ç¼–è¯‘æ—¶é—´: {result.compilation_time:.1f}ç§’")
        
        if result.test_results:
            print(f"\nğŸ§ª æµ‹è¯•ç»“æœ:")
            print(f"   - Lint: {'âœ… é€šè¿‡' if result.test_results['lint']['passed'] else 'âŒ å¤±è´¥'}")
            if result.test_results['lint']['fixed']:
                print(f"     (å·²è‡ªåŠ¨ä¿®å¤)")
            print(f"   - å•å…ƒæµ‹è¯•: {'âœ… é€šè¿‡' if result.test_results['tests']['passed'] else 'âŒ å¤±è´¥'}")
            if result.test_results['tests']['fixed']:
                print(f"     (å·²è‡ªåŠ¨ä¿®å¤)")
        
        print(f"\nğŸ’¡ ä¸‹ä¸€æ­¥:")
        print(f"   cd {result.code_dir}")
        print(f"   pip install -r requirements.txt")
        print(f"   python main.py  # æˆ–æŸ¥çœ‹ README.md")
    else:
        print("\nâŒ ç¼–è¯‘å¤±è´¥ï¼")
        if result.error:
            print(f"\né”™è¯¯ä¿¡æ¯: {result.error}")


def main():
    parser = argparse.ArgumentParser(
        description="PIM Compiler - å°†å¹³å°æ— å…³æ¨¡å‹è½¬æ¢ä¸ºå¯æ‰§è¡Œä»£ç ",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹:
  %(prog)s model.md                     # ç¼–è¯‘åˆ°é»˜è®¤è¾“å‡ºç›®å½•
  %(prog)s model.md -o ./output         # æŒ‡å®šè¾“å‡ºç›®å½•
  %(prog)s model.md -p django           # ç”Ÿæˆ Django ä»£ç 
  %(prog)s model.md --no-test           # è·³è¿‡è‡ªåŠ¨æµ‹è¯•
  %(prog)s model.md --model gemini-2.5-pro  # ä½¿ç”¨ç‰¹å®šæ¨¡å‹

æ”¯æŒçš„å¹³å°:
  - fastapi (é»˜è®¤): FastAPI + SQLAlchemy + Pydantic
  - django: Django + Django ORM
  - flask: Flask + SQLAlchemy
  - spring: Spring Boot + JPA (å®éªŒæ€§)
  - express: Express.js + TypeORM (å®éªŒæ€§)
"""
    )
    
    parser.add_argument(
        "pim_file",
        type=str,
        help="PIM æ–‡ä»¶è·¯å¾„ (Markdown æ ¼å¼)"
    )
    
    parser.add_argument(
        "-o", "--output",
        type=str,
        default="./output",
        help="è¾“å‡ºç›®å½• (é»˜è®¤: ./output)"
    )
    
    parser.add_argument(
        "-p", "--platform",
        type=str,
        default="fastapi",
        choices=["fastapi", "django", "flask", "spring", "express"],
        help="ç›®æ ‡å¹³å° (é»˜è®¤: fastapi)"
    )
    
    parser.add_argument(
        "--model",
        type=str,
        help="Gemini æ¨¡å‹ (é»˜è®¤: ä»ç¯å¢ƒå˜é‡è¯»å–)"
    )
    
    parser.add_argument(
        "--no-test",
        action="store_true",
        help="è·³è¿‡è‡ªåŠ¨æµ‹è¯•å’Œä¿®å¤"
    )
    
    parser.add_argument(
        "--no-lint",
        action="store_true",
        help="è·³è¿‡ lint æ£€æŸ¥"
    )
    
    parser.add_argument(
        "-v", "--verbose",
        action="store_true",
        help="æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—"
    )
    
    parser.add_argument(
        "--version",
        action="version",
        version="%(prog)s 3.1.0"
    )
    
    args = parser.parse_args()
    
    # æ‰“å°æ¨ªå¹…
    if not args.verbose:
        print_banner()
    
    # åŠ è½½ç¯å¢ƒå˜é‡
    env_file = load_env()
    if env_file and args.verbose:
        print(f"âœ“ å·²åŠ è½½ç¯å¢ƒå˜é‡: {env_file}")
    
    # éªŒè¯ PIM æ–‡ä»¶
    pim_file = Path(args.pim_file)
    if not pim_file.exists():
        print(f"âŒ é”™è¯¯: PIM æ–‡ä»¶ä¸å­˜åœ¨: {pim_file}")
        sys.exit(1)
    
    if not pim_file.suffix in ['.md', '.markdown']:
        print(f"âš ï¸  è­¦å‘Š: PIM æ–‡ä»¶åº”è¯¥æ˜¯ Markdown æ ¼å¼ (.md)")
    
    print(f"\nğŸ“„ è¾“å…¥æ–‡ä»¶: {pim_file}")
    print(f"ğŸ¯ ç›®æ ‡å¹³å°: {args.platform}")
    print(f"ğŸ“‚ è¾“å‡ºç›®å½•: {args.output}")
    
    # åˆ›å»ºé…ç½®
    config_dict = {
        "target_platform": args.platform,
        "output_dir": Path(args.output),
        "auto_test": not args.no_test,
        "auto_fix_lint": not args.no_lint,
        "auto_fix_tests": not args.no_test,
        "verbose": args.verbose
    }
    
    if args.model:
        config_dict["gemini_model"] = args.model
    
    try:
        config = CompilerConfig(**config_dict)
    except Exception as e:
        print(f"âŒ é…ç½®é”™è¯¯: {e}")
        sys.exit(1)
    
    # åˆ›å»ºç¼–è¯‘å™¨
    print(f"\nğŸ”§ åˆå§‹åŒ–ç¼–è¯‘å™¨...")
    compiler = CompilerFactory.create_compiler(config)
    
    # æ‰§è¡Œç¼–è¯‘
    print(f"ğŸš€ å¼€å§‹ç¼–è¯‘...\n")
    try:
        result = compiler.compile(pim_file)
        print_result(result)
        
        # è¿”å›é€‚å½“çš„é€€å‡ºç 
        sys.exit(0 if result.success else 1)
        
    except KeyboardInterrupt:
        print("\n\nâš ï¸  ç¼–è¯‘è¢«ç”¨æˆ·ä¸­æ–­")
        sys.exit(130)
    except Exception as e:
        print(f"\nâŒ ç¼–è¯‘å‡ºé”™: {e}")
        if args.verbose:
            import traceback
            traceback.print_exc()
        sys.exit(1)


if __name__ == "__main__":
    main()