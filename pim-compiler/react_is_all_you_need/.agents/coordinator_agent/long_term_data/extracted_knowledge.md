# 知识库

## 元知识
- **生成-验证-修复-验证 (MDA Pipeline)**：标准的任务流程是严格顺序执行的四步管道：1. `code_generator` 生成代码；2. `pytest` 运行初始验证；3. 若测试失败，调用 `code_debugger` 修复；4. 再次运行 `pytest` 确认所有测试通过。这是一个必须完整执行的闭环，不能在任何一步提前中止。
- **Checklist-Driven Execution**: 为确保复杂的多步任务（如MDA Pipeline）被完整执行，Agent 必须通过外部文件（如 `coordinator_todo.json`）来维护和更新任务清单。对于条件性任务（如调试），如果前置条件未满足（如测试全部通过），则应在清单中将其标记为 "skipped"。
- **执行完整性验证**：必须通过 Checklist 机制强制 Agent 执行完整的"生成-验证-修复-验证"循环，直到获得明确的成功信号（如 `pytest` exit code 0）。
- **系统性调试**：当测试失败时，采用循环调试策略：运行测试 -> 定位失败 -> 调用修复工具 -> 重新测试。
- **工具可用性验证**：在执行前必须验证所需工具是否在可用工具集中，否则需要调整执行策略。
- **工具调用完整性**：当工具调用失败时，需要检查工具调用格式是否正确，确保每个工具调用都有对应的响应。
- **枚举值一致性验证**：在涉及枚举类型的系统中，必须验证数据库模型、Pydantic模型和测试数据中的枚举值是否一致，特别是中英文枚举值的映射问题。
- **测试文件冲突检测**：当测试失败时，检查是否存在重复的测试文件或测试用例，避免测试间的相互干扰。
- **零失败即成功模式**：当 `pytest` 返回 exit code 0 时，即使有警告信息（如弃用警告），也视为测试通过，无需进入调试阶段。
- **首次成功模式**：本次任务中，生成的代码首次运行即通过所有测试，验证了MDA Pipeline的完整性和代码生成质量。
- **语法错误专用修复**：新增 `fix_python_syntax_errors` 工具专门处理Python语法错误（缩进、括号不匹配等），避免逐行修复的低效问题。

## 原理与设计
- **模型驱动架构 (MDA)**：系统遵循 MDA 理念，从一个平台特定模型（PSM）文件生成一个功能完整的应用程序。
- **Plan-Driven Coordination**: 整个任务流程由一个预定义的计划（体现为 `coordinator_todo.json`）驱动。
- **双 Agent 协作架构**：系统采用专门的 Agent 来处理不同阶段的任务。
    - `code_generator` Agent：无状态，负责一次性代码生成。
    - `code_debugger` Agent：有状态，通过维护笔记来迭代式地修复问题。
- **测试驱动验证**：项目的成功标准**完全且唯一**地依赖于自动化测试（`pytest`）的通过情况。`pytest` 返回 `exit code 0` 即表示成功。
- **调试焦点**：调试过程中需要特别注意 Pydantic 模型与 FastAPI 路由的兼容性问题，特别是涉及异步会话（AsyncSession）类型时。
- **数据库初始化策略**：测试环境中需要确保数据库表的正确创建，通常通过测试配置或初始化脚本来实现。
- **枚举值设计原则**：在国际化系统中，建议使用英文枚举名作为存储值，中文作为显示值，避免数据库与代码间的值映射问题。
- **首次生成即成功**：本次任务验证了从PSM到完整可运行应用的端到端能力，无需调试阶段。
- **模型定义统一原则**：避免SQLAlchemy模型重复定义，应将所有模型集中在单一文件中，防止"Table already defined"错误。

## 接口与API
- **工具: `write_todo_file`**
    - **功能**: 用于创建和更新任务清单 `coordinator_todo.json`。
- **工具: `code_generator`**
    - **功能**: 基于 PSM 文件生成完整的 FastAPI 应用。
- **工具: `code_debugger`**
    - **功能**: 用于修复失败的 `pytest` 测试。
    - **新增工具**: `fix_python_syntax_errors` - 专门用于修复Python语法错误（缩进、括号不匹配等）
- **工具: `execute_command`**
    - **功能**: 用于执行 shell 命令，尤其用于运行 `pytest` 测试套件。
    - **用法**: `cd output/mda_dual_agent_demo && python -m pytest tests/ -xvs`
    - **扩展用法**: 使用 `-v` 参数查看详细测试输出，避免 `-x` 参数以运行所有测试
- **数据接口: `coordinator_todo.json`**
    - **功能**: 任务清单，用于协调和跟踪 Agent 的执行进度。包含任务状态（如 `pending`, `