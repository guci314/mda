# 知识库

## 元知识
- **调试策略转换**：当一个错误（如数据库 `IntegrityError`）在测试中反复出现，并且修复测试环境（如 `conftest.py` 中的清理逻辑）无效时，应停止修改测试代码，转而怀疑并审查被测试的应用程序代码本身是否存在逻辑缺陷。
- **假设验证**：在修复问题时，如果一个假设（例如"`get_db` 在 `main.py` 中"）被证明是错误的，应立即寻找替代方案（例如，检查 `database.py`）。
- **小步迭代与验证**：在处理库升级（如 Pydantic, SQLAlchemy）或修复复杂 bug 时，进行小范围的、独立的修改，并在每一步后运行测试以快速验证更改是否有效且未引入新问题。
- **错误驱动的测试**：修复一个 bug 后（例如，在 service 中添加了对重复项的检查），应立即更新或创建新的测试用例，以明确验证该 bug 已被修复，并且新的错误处理逻辑（如返回 400 错误）符合预期。
- **类型错误排查**：当遇到类型相关错误（如 AsyncSession 不被识别为有效 Pydantic 类型）时，应检查依赖注入链中的所有类型注解是否一致（同步 Session vs 异步 AsyncSession）。
- **调试初始化流程**：开始调试任务时必须首先初始化调试笔记工具（`init_debug_notes`），以系统化记录调试过程。
- **导入路径诊断**：当遇到模块导入错误时，应首先检查相对导入路径是否正确（如 `from .models` vs `from ..models`），并验证项目目录结构是否匹配。
- **测试数据隔离**：当测试因数据冲突（如唯一约束违反）失败时，应在测试前清理数据库或生成唯一测试数据。
- **语法错误修复**：遇到缩进或括号不匹配时，优先使用 `fix_python_syntax_errors` 工具自动重写整个文件，避免逐行修复引入新问题。
- **数据库初始化策略**：测试环境中使用内存SQLite数据库时，必须在测试前调用 `create_all()` 创建所有表结构，通常在 `conftest.py` 的 session fixture 中完成。
- **枚举值一致性**：当测试与代码使用不同枚举值（如中文 vs 英文）时，应统一使用代码中定义的枚举值，而非硬编码字符串。
- **枚举映射验证**：当枚举值在数据库和应用程序间存在映射问题时，应检查枚举定义、数据库存储值和应用程序使用值的一致性，确保三者使用相同的字符串值而非枚举名称。
- **数据库表缺失诊断**：当出现 "no such table" 错误时，应检查：1) 是否调用了 `create_all()` 创建表；2) 测试数据库是否正确初始化；3) 模型定义是否正确导入。
- **枚举值编码问题**：当使用中文枚举值时，需确保数据库、Python文件和测试文件都使用UTF-8编码，避免编码不一致导致的映射失败。
- **表定义冲突诊断**：当出现 "Table 'xxx' is already defined for this MetaData instance" 错误时，应检查：1) 是否有多个文件定义了相同的表名；2) 模型类是否被重复导入；3) 是否存在旧的模型文件未被清理。
- **模型文件清理策略**：当重构模型结构时，应彻底删除旧的模型文件，而不仅仅是修改导入路径，避免表定义冲突。

## 原理与设计
- **服务层幂等性**：创建型接口（如 `add_book`）应处理重复创建的场景。对于具有唯一约束（如 ISBN）的资源，在插入数据库前必须先查询是否存在，如果存在则应返回一个明确的错误（如 HTTP 400/409），而不是让数据库抛出底层的 `IntegrityError`。
- **测试隔离**：单元测试和集成测试必须在隔离的环境中运行，以确保其独立性和可重复性。对于数据库交互，每个测试用例都应在干净、一致的数据状态下开始。这通常通过为每个测试创建事务并事后回滚来实现，这比每次都重建整个数据库模式更高效。
- **依赖注入（DI）在测试中的应用**：FastAPI 的依赖注入系统是测试的关键。在测试环境中，应通过 `app.dependency_overrides` 来替换生产环境的依赖（如 `get_db`），使其指向一个专为测试设计的、与测试生命周期绑定的依赖（如一个使用测试数据库并自动回滚的 session）。
- **异步架构设计**：当服务层使用 AsyncSession 时，必须确保整个调用链（从路由到 repository）都采用异步模式，避免同步/异步混合导致的类型不匹配问题。
- **模块化设计**：项目应保持清晰的模块边界，如 `schemas/` 目录仅包含数据模型，`models/` 目录包含数据库模型和枚举类型，避免交叉引用导致的导入路径混乱。
- **错误处理层级**：业务逻辑错误应在服务层捕获并转换为合适的HTTP状态码，而不是抛出底层异常。
- **测试数据库