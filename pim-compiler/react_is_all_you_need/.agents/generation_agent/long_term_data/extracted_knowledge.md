# 知识库

## 元知识
- 对于复杂的代码生成任务，应采用"规划-执行"策略：首先将任务分解为一系列清晰、有序的步骤，然后按计划执行。
- 从单一规范（如PSM文件）生成完整应用时，规划应覆盖项目结构创建、各架构层（模型、模式、仓库、服务、路由）的代码生成、依赖项管理和测试框架搭建。
- 代码生成后，应进行迭代式自我修正和验证。检查点包括：依赖项导入是否完整、API使用是否遵循最新版本（如Pydantic v1 vs v2）、代码中是否存在简单的拼写错误。
- 解决依赖问题时，首先检查 `requirements.txt` 是否包含所有必要的库。
- 解决导入错误时，要仔细检查模块路径和命名是否正确。
- 解决类型错误时，要仔细检查数据模型定义和数据传递过程中的类型转换。
- 从PSM文件提取代码时，需要识别Markdown中的代码块语言标记（如```python），并按层级分类提取内容。
- **新增**：PSM文件中的枚举定义应单独提取到独立文件（如`enums.py`），便于复用和维护
- **新增**：生成项目结构时，应先创建完整的目录树，再填充具体文件内容，避免遗漏
- **新增**：对于大型项目，采用分层目录结构（models/schemas/services/routers分离）比扁平结构更易维护
- **新增**：处理实体关系时，先识别所有枚举类型并集中管理，避免重复定义
- **新增**：在生成代码前，先分析PSM文件中的实体关系，识别出所有枚举类型和实体间的关联关系

## 原理与设计
- **FastAPI分层架构**：应用遵循关注点分离的设计原则，构建可维护、可测试的系统。
    - **调用流程**：标准的请求处理流程为 `Routers -> Services -> Repositories`。Routers负责HTTP层，Services封装业务逻辑，Repositories处理数据持久化。
    - `routers`: 负责处理HTTP请求、路径参数和响应，是API的入口层。
    - `services`: 封装核心业务逻辑，协调不同的操作，不直接与数据库交互。
    - `repositories`: 数据访问层（Repository Pattern）。封装数据持久化逻辑（如数据库查询），将业务逻辑与数据源解耦。
    - `schemas` (Pydantic): 定义API的数据契约（输入/OUTPUT），提供自动数据校验和文档生成。
    - `models` (SQLAlchemy): 定义数据库表结构。
    - `database.py` & `dependencies.py`: 集中管理数据库连接和依赖注入。
- **模型驱动生成 (MDG)**：使用平台特定模型（PSM）作为代码生成的"单一事实来源"。PSM文件内包含了生成一个完整应用所需的所有定义（实体、数据模式、API端点等），确保了代码的一致性。
- **应用封装**：将核心应用代码放置在顶层包（如 `app/`）内，是一种标准的Python项目组织方式，有助于避免命名空间冲突和简化部署。
- **数据库初始化**：数据库表创建逻辑（如 `create_all`）应在应用启动时通过 `lifespan` 事件处理程序调用，而不是在模块导入时执行。
- **实体关系处理**：对于复杂的领域模型（如图书借阅系统），需要特别注意实体间的关系（如Book-Reader-Borrowing）在数据库模型和Pydantic模式中的正确映射。
- **复杂业务逻辑**（如借书、还书、预约）应在服务层实现，确保事务完整性和业务规则验证。
- **新增**：枚举类型应集中管理，避免在多个模型中重复定义
- **新增**：服务层应实现事务控制，确保复杂操作的原子性（如借书时的库存检查和记录创建）
- **新增**：对于一对多关系，应在SQLAlchemy模型中使用`relationship`和`back_populates`确保双向关联
- **新增**：Repository模式实现时，每个实体应有对应的Repository类，封装所有数据库操作
- **新增**：在PSM文件中，实体关系通过外键字段和关联字段共同定义，需要在模型中正确实现

## 接口与API
- **核心工具**：
    - `read_file(path)`: 用于读取源规范文件（如PSM）。
    - `create_directory(path)`: 用于创建项目目录结构。
    - `write_file(path, content)`: 用于将生成的代码写入目标文件。
    - `search_replace(path, old, new)`: 用于在生成的文件中查找并替换文本，常用于自我修正。
- **关键配置文件与入口**：
    - `app/main.py`: FastAPI应用的启动入口，负责初始化App并挂载所有路由。
    - `requirements.txt`: 定义项目运行所需的Python依赖库。
    - `app/database.py`: 负责数据库引擎（Engine）和