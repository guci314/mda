# Agent Knowledge - claude_code

## 统计信息
- 任务总数: 4
- 总轮数: 25
- 平均轮数: 6.25
- 最后更新: 2025-09-05

## 已知模式库

### 模式1：知识文件误导
**问题特征**：
- Agent的行为不符合强制协议要求
- Agent执行正确但缺少必要的步骤
- 知识文件中的示例不完整

**解决方案**：
1. 检查知识文件中的示例代码
2. 确保示例包含所有强制要求的操作
3. 在知识文件开头强调核心要求

**关键经验**：
- 示例代码会直接影响Agent行为
- task_process.md的维护必须在每个示例中体现
- 核心要求应该在多个位置重复强调

### 模式2：task_process.md缺失
**问题特征**：
- Agent执行任务时没有创建工作内存
- 复杂任务可能因为缺少状态存储而失败
- 违反了图灵完备的要求

**解决方案**：
1. 第1轮必须创建task_process.md
2. 每轮必须更新进度和状态
3. 在知识文件中明确强调这是必须的

**预防措施**：
- 所有示例都包含task_process.md的操作
- 在system_prompt.md开头就强调
- 将task_process.md放在文件列表的第一位

## 执行优化策略

### 策略1：PSM文档生成优化
- 使用cat >> 进行章节追加，而不是多次write_file
- 同时维护task_process.md记录进度
- 在最后几轮创建session和更新知识

### 策略2：内存管理协议
- 始终遵守mandatory_protocol.md
- task_process.md是图灵完备的关键
- 即使简单任务也要创建所有必需文件

## 常见错误与解决

### 错误1：忽略task_process.md
- **原因**：知识文件示例不完整
- **影响**：无法处理超过50轮的复杂任务
- **解决**：修改所有示例包含task_process.md操作

### 错误2：只关注任务完成
- **原因**：过度优化执行速度
- **影响**：违反内存管理协议
- **解决**：平衡速度与正确性，图灵完备优先

### 模式3：自举验证（Dogfooding）
**概念**：
- 系统通过自己使用自己来验证理论正确性
- Claude Code遵守内存管理协议来验证协议设计

**价值**：
1. 实践验证理论的正确性
2. 发现协议设计的缺陷
3. 提供使用范例
4. 建立信任和可靠性

**实施要点**：
- Claude Code每个任务都使用TodoWrite工具
- 严格维护task_process.md作为工作内存
- 创建session记录追踪所有执行
- 更新knowledge积累经验

### 模式4：API兼容性调试
**⚠️ 重要发现：Claude通过OpenRouter在复杂任务上会死循环！**
**问题特征**：
- LLM调用报错或行为异常
- 工具调用格式不兼容
- 特定模型无法使用

**调试方法**：
1. 创建最小化测试脚本
2. 先测试简单功能（文件操作）
3. 再测试复杂功能（多轮对话、工具调用）
4. 检查配置：模型名称、API Key、Base URL

**常见原因**：
- 模型名称格式错误（OpenRouter需要provider/model格式）
- 使用错误的API Key环境变量
- API服务临时故障
- Rate limiting
- **Claude特定问题**：OpenRouter处理长文档生成时会死循环（第5轮后卡死）

### 模式5：批量配置更新
**应用场景**：
- Jupyter notebook中的批量替换
- 配置文件的统一更新
- 模型迁移

**方法**：
1. 创建Python脚本处理JSON格式的notebook
2. 使用正则表达式批量替换
3. 自动添加缺失的配置参数
4. 验证替换结果

**注意事项**：
- 模型名称必须精确匹配API要求
- 需要同时更新相关配置（如base_url、api_key）
- 保持notebook的JSON格式完整性

## 知识更新记录
- 2025-09-05：创建初始知识库
- 2025-09-05：添加知识文件误导和task_process.md缺失模式
- 2025-09-05：添加自举验证模式，Claude Code开始遵守协议
- 2025-09-05：添加API兼容性调试模式，验证Claude通过OpenRouter可用
- 2025-09-05：添加批量配置更新模式，完成notebook模型迁移