# 自然语言函数最佳实践指南

## 1. 概述

自然语言函数是Agent Builder中的核心编程范式，通过给SOP（标准操作流程）命名并在任务中调用，实现了代码的模块化和复用。本指南将介绍自然语言函数的命名规范、模块化组织和包管理最佳实践。

## 2. 自然语言函数的定义

### 2.1 什么是自然语言函数
自然语言函数是在知识文件中定义的、具有明确名称和步骤的操作流程。它们：
- 使用自然语言描述逻辑
- 可被其他函数或任务调用
- 支持参数传递
- 返回执行结果

### 2.2 基本语法
```markdown
### 函数：函数名(参数1, 参数2, ...)
"""函数的简短描述"""
步骤：
1. 第一步操作
2. 第二步操作
3. ...
返回：返回值描述
```

## 3. 函数命名最佳实践

### 3.1 命名原则

#### 使用动宾结构
```markdown
✅ 好的命名：
- 监控agent(agent_name, task)
- 创建知识文件(content, file_path)
- 验证架构(agent_name)
- 分析日志(log_path)

❌ 避免的命名：
- agent监控器()  # 名词化
- 做监控()       # 太模糊
- monitor()      # 英文混用
```

#### 保持简洁明确
```markdown
✅ 简洁明确：
- 批量训练(bug_count)
- 更新知识(knowledge_path, lessons)

❌ 过于冗长：
- 执行批量训练并生成报告和更新知识文件(...)
```

#### 使用一致的命名风格
```markdown
# 在同一知识文件中保持一致
- 创建agent()
- 测试agent()
- 部署agent()
- 监控agent()
```

### 3.2 参数命名规范

```markdown
### 函数：创建调试agent(bug_file, knowledge_content)
参数说明：
- bug_file: 包含bug的Python文件路径
- knowledge_content: Agent的初始知识内容
```

## 4. 知识文件作为模块

### 4.1 模块化组织

知识文件天然支持模块化组织，每个文件可以定义一组相关函数：

```markdown
# agent_builder_knowledge.md - 核心构建模块
### 函数：监控agent(agent_name, task)
### 函数：验证架构(agent_name)
### 函数：优化知识(agent_name, failure_log)

# debug_knowledge.md - 调试模块  
### 函数：分析错误(error_log)
### 函数：生成修复方案(error_type)
### 函数：验证修复(test_file)

# training_knowledge.md - 训练模块
### 函数：批量训练(task_count)
### 函数：评估性能(metrics)
### 函数：生成报告(results)
```

### 4.2 模块间调用

知识文件可以相互依赖和调用：

```markdown
# learning_knowledge_v2.md
## 依赖
本知识文件依赖于agent_builder_knowledge.md中定义的：
- 函数：监控agent(agent_name, task)
- 函数：验证架构(agent_name)

### 函数：batch_training(bug_count)
步骤：
1. 创建bug场景
2. 对于每个bug：
   - 调用 监控agent(f"debug_agent_{i}", f"修复bug{i}.py")
3. 生成训练报告
```

### 4.3 模块接口设计

良好的模块应该有清晰的接口：

```markdown
# 模块：Agent构建器
## 公开接口
- 监控agent(agent_name, task) -> 监控结果
- 创建agent(...) -> agent实例
- 验证agent(...) -> 验证报告

## 内部函数（不对外暴露）
- _检查日志(log_path)
- _分析架构(agent_config)
```

## 5. 知识文件的包管理特性

### 5.1 自动依赖解析

Agent Builder在加载知识文件时会自动解析依赖关系：

```python
# 在Python代码中指定知识文件依赖
knowledge_files=[
    "learning_knowledge_v2.md",           # 主知识文件
    "agent_builder_knowledge.md"          # 依赖的知识文件
]
```

### 5.2 版本管理

通过Git管理知识文件版本：

```markdown
# knowledge/agent_builder_knowledge.md
## 版本历史
- v2.0: 添加监控agent函数
- v1.5: 优化验证流程
- v1.0: 初始版本
```

### 5.3 命名空间

使用前缀避免函数名冲突：

```markdown
# 调试模块
### 函数：debug_分析错误(...)
### 函数：debug_修复代码(...)

# 测试模块  
### 函数：test_执行测试(...)
### 函数：test_生成报告(...)
```

## 6. 实战示例

### 6.1 定义核心函数库

```markdown
# core_functions.md
### 函数：初始化项目(project_name, config)
"""创建新项目并初始化配置"""
步骤：
1. 创建项目目录
2. 初始化配置文件
3. 创建基础结构
返回：项目路径

### 函数：执行任务(task_name, params)
"""执行指定任务"""
步骤：
1. 验证任务参数
2. 调用对应执行器
3. 记录执行日志
返回：执行结果
```

### 6.2 构建高级功能

```markdown
# advanced_functions.md
## 依赖
- core_functions.md

### 函数：批量处理(task_list)
"""批量执行多个任务"""
步骤：
1. 调用 初始化项目("batch_job", {})
2. 对于task_list中的每个任务：
   - 调用 执行任务(task.name, task.params)
   - 记录结果
3. 生成批量处理报告
返回：批量处理结果
```

### 6.3 在任务中使用

```python
# 任务定义
task = """
1. 调用 初始化项目("my_app", {"type": "web"})
2. 调用 批量处理([
    {"name": "setup_db", "params": {}},
    {"name": "create_api", "params": {}}
])
3. 调用 生成报告(results)
"""
```

## 7. 最佳实践总结

### 7.1 DO - 推荐做法

1. **函数职责单一**：每个函数只做一件事
2. **参数明确**：清晰定义输入参数和返回值
3. **错误处理**：在步骤中包含异常处理逻辑
4. **文档完整**：提供函数描述和参数说明
5. **模块化组织**：相关函数放在同一知识文件
6. **依赖声明**：明确声明对其他知识文件的依赖

### 7.2 DON'T - 避免做法

1. **避免过度嵌套**：函数调用层级不要超过3层
2. **避免循环依赖**：A依赖B，B又依赖A
3. **避免全局状态**：函数应该是无状态的
4. **避免混合语言**：保持中文或英文的一致性
5. **避免过长函数**：步骤超过10步考虑拆分

## 8. 进阶技巧

### 8.1 条件执行

```markdown
### 函数：智能部署(env, config)
步骤：
1. 如果env是"production"：
   - 执行完整测试
   - 备份现有系统
2. 否则：
   - 执行快速验证
3. 部署应用
返回：部署状态
```

### 8.2 循环处理

```markdown
### 函数：重试执行(task, max_attempts)
步骤：
1. 设置attempt = 0
2. 当attempt < max_attempts时：
   - 尝试执行task
   - 如果成功，返回结果
   - 如果失败，attempt += 1
3. 返回失败状态
```

### 8.3 异步调用模式

```markdown
### 函数：并行处理(task_list)
步骤：
1. 对于task_list中的每个任务：
   - 创建独立Agent执行任务（异步）
2. 等待所有Agent完成
3. 收集所有结果
返回：汇总结果
```

## 9. 调试和测试

### 9.1 单元测试函数

```markdown
### 函数：测试_监控agent()
"""测试监控agent函数"""
步骤：
1. 创建测试Agent
2. 调用 监控agent("test_agent", "test_task")
3. 验证返回结果包含预期字段
4. 清理测试环境
返回：测试通过/失败
```

### 9.2 集成测试

```markdown
### 函数：端到端测试()
步骤：
1. 调用 初始化项目()
2. 调用 创建agent()
3. 调用 执行任务()
4. 调用 验证结果()
返回：完整测试报告
```

## 10. 知识文件的演化

### 10.1 从简单到复杂

```markdown
# 版本1：简单函数
### 函数：处理文件(file_path)
步骤：
1. 读取文件
2. 处理内容
3. 保存结果

# 版本2：增加错误处理
### 函数：处理文件(file_path, error_handler)
步骤：
1. 验证文件存在
2. 读取文件
3. 如果读取失败，调用error_handler
4. 处理内容
5. 保存结果

# 版本3：支持批量和并行
### 函数：批量处理文件(file_list, parallel=False)
步骤：
1. 如果parallel为True：
   - 并行处理所有文件
2. 否则：
   - 串行处理每个文件
3. 汇总所有结果
返回：处理报告
```

### 10.2 知识继承和扩展

```markdown
# base_knowledge.md
### 函数：基础处理(data)

# extended_knowledge.md  
## 继承：base_knowledge.md

### 函数：高级处理(data, options)
步骤：
1. 调用 基础处理(data)
2. 应用高级选项
3. 返回增强结果
```

## 结语

自然语言函数是Agent Builder实现"知识即代码"理念的核心机制。通过合理的命名、模块化组织和包管理，我们可以构建出强大、灵活且易于维护的Agent系统。记住：
- **简单优于复杂**
- **清晰优于晦涩**
- **模块化优于单体**
- **复用优于重复**

遵循这些最佳实践，你将能够充分发挥自然语言函数的威力，构建出优雅高效的Agent应用。