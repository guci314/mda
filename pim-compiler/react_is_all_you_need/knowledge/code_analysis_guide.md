# 代码分析任务指导手册

## 核心原则：不要猜测，要验证

**黄金法则**：永远不要基于函数名猜测功能，必须查看实际代码。

## 标准分析流程（必须严格遵循）

### 第1步：理解任务 ✅
分析用户的问题，识别关键词：
- 如果问"X是什么功能"→ 需要找到X的定义
- 如果问"X如何工作"→ 需要找到X的实现
- 如果问"X在哪里使用"→ 需要找到调用X的地方

### 第2步：搜索策略 🔍

#### 2.1 优先使用精确搜索
```python
# 好的搜索策略
search_functions("def function_name")  # 精确搜索函数定义
search_functions("class ClassName")    # 精确搜索类定义
search_functions("function_name(")     # 搜索函数调用

# 错误的搜索策略
search_functions("function")  # 太宽泛，会匹配所有包含function的内容
```

#### 2.2 搜索顺序
1. 先搜索定义：`def 函数名` 或 `class 类名`
2. 再搜索使用：`函数名(` 或 `类名(`
3. 最后搜索导入：`from ... import 函数名`

### 第3步：代码分析方法 📖

#### 3.1 读代码的关键位置
```python
def function_name(parameters):  # 1. 看参数
    """docstring"""             # 2. 看文档
    # 实现代码                   # 3. 看实现逻辑
    return result               # 4. 看返回值
```

#### 3.2 理解代码的检查清单
- [ ] 函数接收什么参数？
- [ ] 函数返回什么？
- [ ] 函数内部做了什么操作？
- [ ] 函数调用了哪些其他函数？
- [ ] 有没有副作用（修改外部状态）？

### 第4步：验证理解 ✓

#### 4.1 交叉验证
- 找到函数定义后，搜索它的调用位置
- 看调用时传入的实际参数
- 看调用后如何使用返回值

#### 4.2 上下文验证
- 查看同文件中的相关函数
- 查看导入语句了解依赖
- 查看类的其他方法理解整体设计

## 常见错误模式（必须避免）❌

### 错误1：基于名字猜测功能
```python
# 看到 _build_minimal_prompt 就猜测是"构建最小提示词"
# 错误！必须看代码才能确定
```

### 错误2：忽略实际实现
```python
def save_data():
    """保存数据"""
    # 实际上可能是删除数据
    delete_all()  # 必须看实现！
```

### 错误3：断章取义
```python
# 只看了函数的前几行就下结论
# 必须看完整个函数
```

### 错误4：循环搜索
```python
# 搜索A → 搜索B → 搜索C → 又搜索A
# 应该：搜索A → 分析A → 得出结论
```

## 具体任务示例

### 示例1：分析 _build_minimal_prompt 的功能

**正确步骤**：
1. 搜索定义：`search_functions("def _build_minimal_prompt")`
2. 找到后读取完整代码
3. 分析代码逻辑：
   - 看参数：接收什么输入
   - 看实现：具体做什么操作
   - 看返回：返回什么结果
4. 搜索调用：`search_functions("_build_minimal_prompt(")`
5. 验证理解：调用时的上下文是否符合分析

**错误做法**：
- ❌ 看到名字就说"构建最小提示词"
- ❌ 不看代码实现
- ❌ 不验证实际使用

### 示例2：理解模块结构

**正确步骤**：
1. 列出文件：`list_files("*.py")`
2. 查看主要类：`search_functions("class ")`
3. 查看主要函数：`search_functions("def ")`
4. 理解调用关系

## 输出格式规范

### 分析结果模板
```markdown
## 函数：function_name

**位置**：文件路径:行号

**功能**：
- 主要功能描述（基于代码分析，不是猜测）

**参数**：
- param1: 类型，用途
- param2: 类型，用途

**返回值**：
- 类型和含义

**实现细节**：
1. 步骤1：做什么
2. 步骤2：做什么
3. 步骤3：做什么

**调用位置**：
- 文件1:行号 - 调用场景
- 文件2:行号 - 调用场景

**结论**：
基于以上分析，该函数的作用是...（必须有依据）
```

## 调试策略

### 当找不到函数时
1. 检查拼写
2. 尝试部分匹配：`search_functions("partial_name")`
3. 查看类的方法：`search_functions("class ClassName")` 然后读取整个类
4. 查看导入：可能是外部库的函数

### 当代码太复杂时
1. 分段理解：一次理解一部分
2. 画执行流程：输入→处理→输出
3. 找关键行：return语句、主要函数调用
4. 忽略细节：先理解主干，再看细节

## 关键提醒 ⚠️

1. **不要假设**：代码会说真话，名字可能骗人
2. **不要省略**：必须看完整代码
3. **不要循环**：有目标地搜索，不要漫无目的
4. **要验证**：通过多个角度确认理解
5. **要具体**：给出基于代码的具体分析，不要泛泛而谈

## 最重要的规则

**如果你不确定，就说"我需要查看代码"，然后去查看。**
**永远不要基于推测给出答案。**
**代码是唯一的真相来源。**

## 检查清单（每次分析前复查）

- [ ] 我是否查看了实际代码？
- [ ] 我是否理解了完整的实现？
- [ ] 我是否验证了我的理解？
- [ ] 我的结论是否有代码依据？
- [ ] 我是否避免了猜测？

记住：**宁可多搜索几次，也不要凭猜测回答。**