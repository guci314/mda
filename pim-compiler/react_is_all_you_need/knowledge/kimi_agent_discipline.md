# Kimi Agent 执行纪律

## 核心原则：保持理智，避免循环

### 1. 选择合适的执行模式

#### 使用 NLTM（自然语言图灵机）当：
- 任务需要多个步骤
- 包含条件判断或循环
- 需要维护状态
- 可能需要重试或恢复

```yaml
# NLPL程序通用模板
程序: [任务名称]
  目标: [明确目标]
  状态:
    - 当前步骤: 开始
    - 成功标志: false
    - 计数器: 0
  主流程:
    步骤1: 初始化
    步骤2: 主要逻辑（可能包含循环）
    步骤3: 完成并验证
```

#### 使用 TODO 列表当：
- 任务步骤固定且简单
- 不需要复杂逻辑
- 一次性完成

```markdown
# 简单任务计划
1. [ ] 第一步
2. [ ] 第二步  
3. [ ] 第三步
```

### 2. 文件操作铁律

#### 正确的文件写入模式：
```
第1次：write_file（创建文件，≤4000字符）
第2-N次：append_file（追加内容，每次≤3000字符）
```

#### NLTM状态管理：
```
execution.json: write_file（每次完整覆盖，保持≤4000字符）
program.nlpl: write_file（一次性写入完整程序）
历史记录: append_file到history.log
```

#### 错误的模式（绝对禁止）：
```
❌ 连续多次 write_file 到同一个文件
❌ 重复相同操作超过3次
❌ 不验证前一步的结果就继续
```

### 3. 循环检测与退出

**三次规则**：
- 如果同一个操作执行3次都失败，**必须停下来重新分析**
- 如果连续3次修改同一个文件，**必须验证文件内容**
- 如果陷入循环，**必须写一个分析报告**

### 4. 调试时的强制步骤

```python
# 调试流程
1. 运行测试，获取错误信息
2. 读取失败的文件，理解当前状态
3. 分析错误原因（不要猜测）
4. 制定修复计划
5. 执行修复（一次修复一个问题）
6. 验证修复效果
7. 如果还有错误，返回步骤1（最多3轮）
```

### 5. 防止精神错乱的检查清单

在每轮执行前，问自己：
- [ ] 我是否在重复上一轮的操作？
- [ ] 我是否理解了错误的真正原因？
- [ ] 我的修复方案是否合理？
- [ ] 我是否需要先读取文件了解现状？

### 6. 紧急制动机制

如果出现以下情况，**立即停止**：
- 连续5次相同的工具调用
- 连续10次write_file（应该用append_file）
- 错误信息没有变化但还在重试
- 执行轮数超过50但没有实质进展

### 7. 示例：正确的调试过程

```markdown
轮次1：执行pytest → 发现导入错误
轮次2：read_file查看test_articles.py → 理解当前代码
轮次3：分析错误：缺少httpx导入
轮次4：write_file修复导入（第一部分）
轮次5：append_file添加测试代码（第二部分）
轮次6：append_file完成测试代码（第三部分）
轮次7：执行pytest验证 → 成功！
```

### 8. 示例：错误的调试过程（要避免）

```markdown
轮次1：执行pytest → 失败
轮次2-50：不断write_file覆盖同一个文件 ❌
结果：陷入无意义循环，文件永远不完整
```

## NLTM执行流程（新增）

当任务复杂度高时，使用NLTM：

1. **Program** - 编写NLPL程序
2. **Initialize** - 创建execution.json状态
3. **Execute** - 按步骤执行，更新状态
4. **Adapt** - 根据结果动态调整
5. **Complete** - 生成执行报告

## 记住：保持冷静，有条不紊

1. **Think** - 思考问题
2. **Plan** - 制定计划（NLTM或TODO）
3. **Execute** - 执行方案
4. **Verify** - 验证结果
5. **Iterate** - 必要时迭代（但不要盲目重复）

## 最重要的规则

**如果你发现自己在做重复的事情，立即停下来！**

写一个反思：
- 我在试图解决什么问题？
- 我的方法为什么不起作用？
- 我需要改变什么策略？

保持理智，避免"精神错乱"！