# 学习知识函数

本文件定义了Agent的学习和记忆机制。通过知识函数实现，而非硬编码。

## 核心理念：运行时知识积累

**设计时 vs 运行时**：
- **设计时知识**：知识文件（如本文件），定义Agent的学习能力
- **运行时知识**：experience.md，Agent运行时积累的经验

学习函数帮助Agent将运行时经验持久化。

## @learning 知识函数

当你需要从本次会话中学习经验时，请执行以下步骤：

### 执行前检查
- **大小限制**：experience.md不应超过10KB（约10,000字符）
- 如果接近限制，需要压缩或归档旧条目

### 执行步骤
1. **回顾消息历史**
   - 浏览你在本次会话中的所有消息
   - 特别关注你使用的工具、遇到的错误、解决方案
   - **重要**：必须基于实际发生的事件，不要编造

2. **诚实评估**
   - **如果没有值得学习的内容**：诚实报告"本次会话没有特别的经验教训"
   - **不要为了完成任务而编造教训**
   - 只记录真实发生并有价值的经验

3. **识别模式**（只有确实存在时才记录）
   - **错误模式**：你遇到了哪些错误？如何解决的？
   - **成功模式**：哪些策略很有效？
   - **工具偏好**：你最常用哪些工具？
   - **复杂度指标**：任务需要多少轮思考？
   - **重要事实**：发现了哪些客观事实？（如API限制、版本信息、配置要求等）

4. **提取教训和事实**（只提取真实的内容）
   - **必须基于实际事件**
   - **不要从知识文件复制通用建议**
   - **重要事实也值得记录**（如发现的限制、配置、版本等）
   - **如果没有值得记录的内容，诚实报告**
   ```markdown
   类型：[错误处理/工具偏好/任务策略/性能优化/事实发现]
   场景：[实际发生的具体场景]
   内容：[从实际经验中得出的教训或发现的事实]
   置信度：[0.6-1.0]
   ```

5. **更新experience.md**
   - Agent的home目录：`~/.agent/[agent名]/experience.md`
   - **检查文件大小**：如果超过8KB，先压缩旧条目
   - 在"## 教育记录"部分追加新的教训
   - 使用时间戳和[@learning]标记
   - 格式示例：
   ```markdown
   ### 2025-09-21 22:00 [@learning]

   **类型**: 工具偏好
   **场景**: 搜索代码时
   **内容**: grep_search比read_file更高效
   **置信度**: 0.8

   ---

   ### 2025-09-21 22:05 [@learning]

   **类型**: 事实发现
   **场景**: 检查ReactAgentMinimal代码
   **内容**: _save_compact_memory()在第942行，会在70k tokens时自动触发
   **置信度**: 1.0

   ---
   ```

### 触发时机
- 完成重要任务后
- 遇到并解决了新问题
- 发现了更好的工作模式
- 用户要求你学习时

### 示例对话

#### 有经验可学习时：
```
用户：请从这次会话中学习经验
助手：让我回顾本次会话并总结经验教训...

[分析消息历史]

我从本次会话中学到了：
1. 使用grep_search工具5次，它很适合代码搜索（工具偏好）
2. 遇到localhost代理问题，需要禁用代理（错误处理）
3. 发现ReactAgentMinimal内置_save_compact_memory()方法（事实发现）
4. 任务较复杂，需要12轮思考（复杂度指标）

已使用write_file工具将这些经验和事实更新到`~/.agent/[agent名]/experience.md`中。
```

#### 没有经验可学习时：
```
用户：@learning
助手：让我回顾本次会话...

[分析消息历史]

本次会话主要是：
- 记录了您的名字
- 执行了简单的记忆任务

没有遇到特殊问题或发现新的工作模式，
因此没有需要学习的新经验。
```

## @memory 知识函数

当用户直接教育你时，请记住他们的指示。

### 执行步骤
1. **解析用户指令**
   - 识别"记住："、"记住这个："、"重要："等关键词
   - 提取核心教训内容

2. **结构化记忆**
   ```markdown
   类型：用户教育
   内容：[用户的具体指示或事实]
   置信度：1.0（用户直接教的，最可信）
   ```

3. **更新experience.md**
   - 立即更新到"## 教育记录"部分
   - 使用[@memory]标记
   - 格式示例：
   ```markdown
   ### 2025-09-21 22:00 [@memory]

   **类型**: 用户教育
   **内容**: 访问localhost时必须使用--noproxy参数
   **置信度**: 1.0

   ---
   ```

### 触发时机
- 用户说"记住：..."
- 用户纠正你的错误
- 用户提供重要配置信息
- 用户分享最佳实践

### 示例对话
```
用户：记住：使用Gemini API时需要配置httpx client with proxy
助手：✅ 已记住：使用Gemini API时需要配置httpx client with proxy
这个重要信息已使用write_file工具更新到`~/.agent/[agent名]/experience.md`中，我会在未来的任务中应用。
```

## experience.md 大小管理

### 大小限制
- **目标大小**：< 10KB（10,000字符）
- **警告阈值**：8KB时开始压缩
- **硬限制**：绝不超过15KB

### 压缩策略
当experience.md接近8KB时，执行智能压缩：

1. **合并相似教训**
   - 相同类型、相似内容的教训合并为一条
   - 保留最高置信度

2. **删除低价值条目**
   - 置信度 < 0.6 的旧条目
   - 超过30天未被引用的条目
   - 重复或冗余的内容

3. **归档历史**
   - 将旧教训移到 `agent_archive.md`
   - 只保留最近和最重要的教训

### 压缩示例
```markdown
# 压缩前（3条相似教训）
### 2025-09-01 [@learning]
**类型**: 错误处理
**教训**: localhost需要禁用代理

### 2025-09-10 [@learning]
**类型**: 错误处理
**教训**: 访问127.0.0.1需要禁用代理

### 2025-09-20 [@learning]
**类型**: 错误处理
**教训**: 本地请求都需要禁用代理

# 压缩后（1条合并教训）
### 2025-09-20 [@learning-merged]
**类型**: 错误处理
**教训**: 所有本地请求(localhost/127.0.0.1)都需要禁用代理
**置信度**: 1.0
**合并次数**: 3
```

## 知识函数的优势

1. **灵活性**：通过自然语言定义，易于理解和修改
2. **可扩展**：添加新的学习策略只需更新知识文件
3. **透明度**：用户可以看到Agent如何学习
4. **无需代码**：不增加ReactAgentMinimal的复杂度

## 使用指南

### 对于Agent开发者
- 这些函数通过Agent的理解能力执行
- 不需要硬编码的Python实现
- Agent读取这个知识文件就知道如何学习

### 对于用户
- 可以随时让Agent执行@learning来总结经验
- 可以通过@memory直接教育Agent
- 所有学习记录都保存在`~/.agent/[agent名]/experience.md`中，可查看和编辑

## 设计哲学

**"知识即程序"** - 这些知识函数证明了：
- 复杂的行为可以通过知识描述实现
- Agent的智能足以理解和执行知识指令
- 代码只提供基础能力，知识定义高级行为

这就是"大道至简"的体现：用最少的代码，通过知识实现最强的功能。