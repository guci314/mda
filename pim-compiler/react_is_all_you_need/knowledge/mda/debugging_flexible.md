# 灵活调试知识 - 根据实际需要调整策略

## 核心原则

### 优先级判断
1. **首先判断错误的根本原因**
2. **选择最小代价的修复方案**
3. **优先修复功能代码，但在必要时可以调整测试**

## 错误处理策略

### 1. 404错误 - 灵活处理
```python
def handle_404_error(error_detail):
    # 分析错误上下文
    if "路由确实缺失":
        # 优先创建缺失的功能
        create_missing_route()
    elif "测试期望不合理":
        # 可以调整测试的期望值
        adjust_test_expectation()
    elif "路径拼写错误":
        # 修复路径问题（可能在测试或功能中）
        fix_path_typo()
```

### 2. 数据验证错误（400/422）
- **功能问题**：Schema定义不完整 → 修复Schema
- **测试问题**：测试数据不完整 → 补充测试数据
- **两边都有问题**：根据业务需求调整两边

### 3. 测试配置问题
当测试框架本身有问题时（如async/sync不匹配）：
- 可以修改conftest.py
- 可以调整测试文件的导入
- 可以更改fixture定义

## 实用主义原则

### 什么时候可以修改测试？

1. **测试本身有bug**
   - 语法错误
   - 导入错误
   - fixture配置错误

2. **测试与实际架构不匹配**
   - 异步测试 vs 同步实现
   - 错误的API路径
   - 过时的数据格式

3. **测试期望不合理**
   - 要求不存在的字段
   - 错误的状态码期望
   - 不符合业务逻辑的验证

### 什么时候必须修改功能？

1. **核心功能缺失**
   - 整个模块未实现
   - 关键业务逻辑缺失
   - 数据库模型未创建

2. **明显的功能bug**
   - 逻辑错误
   - 数据处理错误
   - 安全漏洞

## 判断流程

```
遇到测试失败
    ↓
分析失败原因
    ↓
评估修复成本
    ├─ 修改功能成本低 → 修改功能
    ├─ 修改测试成本低 → 修改测试
    └─ 两边都需要调整 → 同时修改
```

## 实际案例

### 案例1：路径不匹配
- **问题**：测试期望 `/api/books/`，实际路由是 `/books/`
- **解决**：修改测试中的路径（成本最低）

### 案例2：异步架构不匹配
- **问题**：测试使用AsyncClient，应用是同步的
- **解决**：修改测试使用同步TestClient

### 案例3：字段名不一致
- **问题**：测试发送`isbn`，Schema期望`book_isbn`
- **解决**：统一字段名（可以改测试或Schema，看哪个更合理）

## 关键提醒

1. **目标是让系统工作**，而不是坚持教条
2. **选择阻力最小的路径**
3. **保持代码的一致性和可维护性**
4. **记录所做的改动和原因**

## 调试工具使用

- `fix_python_syntax_errors`：可用于测试文件和功能文件
- `search_replace`：精确替换任何文件
- `write_file`：重写有严重问题的文件
- `edit_lines`：修改特定行

记住：**实用主义 > 教条主义**。目标是快速解决问题，让测试通过。