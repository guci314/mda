# 三层架构笔记系统

⚠️ **重要提示**：这是结构化笔记方案，与简单笔记（session_notes.md）方案互斥。
请根据任务复杂度选择其一，不要混用。

## 核心理念
你通过三个不同层次的笔记来组织和管理知识，就像科学家同时维护实验记录、研究笔记和知识总结。

**⚠️ 强制规则（无例外）**：
1. **environment.md 必须创建** - 不管任务多简单，都必须在开始和结束时创建
2. **task_state.md 必须创建** - 不管任务多简单，都必须创建并跟踪
3. **experience.md 按需创建** - 有新发现时更新

**🚨 违规检查**：如果你没有创建environment.md和task_state.md，就是违反了规则

## 三层笔记架构

## 任务定义
**重要**：以下都算作"任务"，都需要创建笔记：
- 创建代码或文件
- 总结或分析内容
- 查询或搜索信息
- 解释或回答问题
- 任何需要执行工具的操作

### 第一层：经验库笔记 (experience.md)
**目的**：积累可复用的模式和解决方案，形成长期知识资产

**触发时机**：
- 发现新的解决模式
- 遇到并解决了新类型的错误
- 找到了更优的实现方法
- 完成任务后的重要总结

**内容模板**：
```markdown
# 经验库

## 成功模式
### [模式名称]
- **适用场景**：什么情况下使用
- **解决方案**：具体步骤或代码
- **效果**：预期结果
- **注意事项**：潜在陷阱

## 错误模式
### [错误类型]
- **表现**：错误信息或症状
- **原因**：根本原因分析
- **解决**：修复方法
- **预防**：如何避免

## 最佳实践
### [实践领域]
- **原则**：核心指导原则
- **示例**：具体案例
- **收益**：为什么这样做

---
更新时间：[自动时间戳]
```

### 第二层：任务状态笔记 (task_state.md)
**目的**：跟踪当前任务进展，保持工作连续性

**触发时机**：
- 开始新任务
- 完成重要步骤
- 遇到阻塞或决策点
- 任务上下文切换

**内容模板**：
```markdown
# 任务状态

## 当前任务
- **目标**：[明确的任务目标]
- **开始时间**：[时间戳]
- **优先级**：高/中/低

## TODO列表
### 正在进行 🔄
- [ ] 当前任务：具体描述
  - 进度：[0-100%]
  - 开始：[时间]

### 待办事项 📋
- [ ] 高优先级：必须完成的任务
- [ ] 中优先级：应该完成的任务
- [ ] 低优先级：可以完成的任务

### 已完成 ✅
- [x] 完成任务1：具体内容 [完成时间]
- [x] 完成任务2：具体内容 [完成时间]

## 执行详情
### 当前焦点
- **正在做**：[具体步骤描述]
- **下一步**：[计划的下一个动作]
- **阻塞点**：[如果有阻塞，记录原因]

### 关键决策
- **决策点**：[需要决定什么]
- **选择方案**：[选了哪个]
- **理由**：[为什么这样选]
- **风险**：[潜在问题]

## 重要信息
### 发现与洞察
- [关键发现、重要路径、有用的命令]

### 错误与解决
- **错误**：[遇到的错误]
- **原因**：[分析的原因]
- **解决**：[如何解决的]

## 工作数据
```
[临时代码片段、测试数据、中间结果]
```

## 依赖关系
- **前置任务**：[必须先完成的]
- **后续任务**：[完成后要做的]
- **并行任务**：[可以同时进行的]

---
最后更新：[自动时间戳]
下次复查：[预计时间]
```

### 第三层：环境知识笔记 (environment.md)
**目的**：记录环境状态快照，提供一致的环境视图

**⚠️ 核心原则**：
- **状态快照，非增量变化** - 每次记录完整的环境状态
- **事务边界处记录** - 只在任务开始和完成时记录
- **隔离性保证** - 执行中不更新，避免中间状态污染

**触发时机（必须）**：
- **任务开始时**（必须）- 记录当前环境状态（快照）
- **任务完成时**（必须）- 记录完成后的环境状态（新快照）
- 不在执行中更新 - 保持事务隔离性

**内容模板**：
```markdown
# 环境知识

## 系统架构
### 架构概览
```
[系统架构图，用文字描述]
┌─────────┐     ┌─────────┐
│组件A    │────▶│组件B    │
└─────────┘     └─────────┘
     │               │
     ▼               ▼
┌─────────┐     ┌─────────┐
│数据库   │     │外部API  │
└─────────┘     └─────────┘
```

### 核心组件
- **组件名称**：
  - 职责：[主要功能]
  - 位置：[代码路径]
  - 依赖：[依赖的其他组件]
  - 接口：[提供的接口]

### 数据流
- **主要流程**：
  1. 用户请求 → [组件A]
  2. [组件A] 处理 → [组件B]
  3. [组件B] 查询 → [数据库]
  4. 返回结果 → 用户

### 组件交互
- **同步调用**：
  - A → B：[调用方式，如函数调用]
  - B → C：[调用方式，如HTTP请求]
- **异步通信**：
  - 消息队列：[使用的队列系统]
  - 事件系统：[事件发布/订阅]

## 项目结构
### 核心目录
- `src/`: 主要源代码
  - `core/`: 核心业务逻辑
  - `api/`: API接口层
  - `services/`: 服务层
  - `models/`: 数据模型
- `tests/`: 测试文件
- `config/`: 配置文件
- [其他重要目录]

### 关键文件
- **入口**：main.py - 程序入口点
- **配置**：config.yaml - 主配置文件
- **路由**：routes.py - API路由定义
- **模型**：models.py - 数据模型定义

## 技术栈
### 语言和框架
- 主语言：Python 3.x
- Web框架：[FastAPI/Flask/Django]
- ORM：[SQLAlchemy/Django ORM]
- 依赖：[requirements.txt中的主要包]

### 数据存储
- 主数据库：[PostgreSQL/MySQL/SQLite]
- 缓存：[Redis/Memcached]
- 文件存储：[本地/S3/OSS]

## API和接口
### 外部服务依赖
- **服务名称**：
  - 用途：[为什么需要]
  - 端点：[API URL]
  - 认证：[API key/OAuth/JWT]
  - 限制：[速率限制/配额]
  - 备用方案：[失败时的处理]

### 内部接口定义
- **模块间接口**：
  - 路径：[/api/v1/resource]
  - 方法：[GET/POST/PUT/DELETE]
  - 参数：[参数schema]
  - 返回：[响应schema]
  - 错误码：[可能的错误]

## 开发约定
### 代码规范
- 命名规则：[snake_case/camelCase]
- 文件组织：[按功能/按层次]
- 注释标准：[docstring格式]
- 提交规范：[commit message格式]

### 工作流程
- 本地开发：[启动命令]
- 运行测试：[测试命令]
- 代码检查：[lint命令]
- 构建打包：[build命令]
- 部署流程：[部署步骤]

## 配置管理
### 环境变量
- `DATABASE_URL`: 数据库连接
- `API_KEY`: 外部API密钥
- `DEBUG`: 调试模式开关
- [其他环境变量]

### 配置文件
- `config.yaml`: 主配置
- `.env`: 环境变量
- `settings.py`: 应用设置

## 常见问题
### 已知陷阱
- [常见错误及解决方案]

### 调试技巧
- [有用的调试命令或方法]

---
记录时间：[自动时间戳]
状态类型：[任务开始/任务完成]
```

## 笔记创建示例

### 即使是简单任务也必须创建笔记
**例子：总结目录任务**
1. 开始时创建 task_state.md：记录"总结目录"的TODO
2. 开始时创建 environment.md：记录当前工作目录和文件列表
3. 完成时更新 task_state.md：标记完成
4. 完成时更新 environment.md：记录探索到的完整目录结构

## 笔记管理策略

### 写入时机
根据语义边界和任务进展主动写入：

1. **经验库写入时机**
   - 发现了可复用的解决模式
   - 成功解决了新类型的问题
   - 遇到并修复了典型错误
   - 总结出最佳实践

2. **任务状态写入时机**
   - 开始新任务或子任务
   - 完成TODO列表中的项目
   - 做出重要技术决策
   - 发现关键信息或数据
   - 遇到阻塞需要记录上下文

3. **环境知识写入时机**（必须）
   - **任务开始时立即写入**（强制）- 环境状态快照
   - **任务完成时必须写入**（强制）- 新的环境状态快照
   - 执行中不更新 - 保持事务隔离性
   - 每次都是完整的状态记录，不是增量变化

### 读取时机
根据任务需要和上下文主动读取：

1. **经验库读取时机**
   - 遇到类似问题时查找解决方案
   - 开始新任务前查看相关最佳实践
   - 调试错误时查找类似错误模式
   - 需要决策时参考之前的成功模式

2. **任务状态读取时机**
   - 会话开始时恢复上一次状态
   - 需要确认TODO列表和优先级
   - 忘记当前进展时快速回顾
   - 切换任务前保存并读取新任务状态

3. **环境知识读取时机**
   - 需要了解某个组件的职责和位置
   - 调用API前查看接口定义和限制
   - 修改代码前了解编码规范
   - 遇到配置问题时查看配置说明
   - 不确定系统架构时查看组件关系

### 读取优先级
1. **任务恢复**：任务状态 > 环境知识 > 经验库
2. **问题解决**：经验库 > 环境知识 > 任务状态  
3. **新功能开发**：环境知识 > 任务状态 > 经验库
4. **调试修复**：经验库 > 任务状态 > 环境知识

### 更新原则
1. **状态更新**：直接覆盖更新，只保留最新状态
2. **定期提炼**：任务完成后提炼精华到经验库
3. **及时性**：状态变化立即更新

### 文件组织
```
.notes/
  ├── experience.md      # 长期保留，跨任务共享
  ├── task_state.md      # 任务期间保留，完成后可清理
  └── environment.md     # 项目期间保留，定期更新
```

## 记忆类型理论

### 状态型记忆（当前三层笔记）
**特征**：反映系统、任务、环境的当前状态
- **经验库**：Agent的知识状态（先验）
- **任务状态**：任务的执行状态（当前）
- **环境知识**：环境的结构状态（缓存）

**更新方式**：覆盖更新，只保留最新状态
- 像数据库的UPDATE操作
- 像会计的资产负债表（某时点的快照）
- 不需要历史，因为状态是自包含的

### 过程型记忆（未来扩展）
**特征**：记录事件流、变化过程、因果链
- **事件日志**：发生了什么（when, what, why）
- **决策记录**：选择的理由和过程
- **变更历史**：状态如何演变

**更新方式**：追加式，保留完整历史
- 像数据库的INSERT操作
- 像会计的凭证（每笔交易的记录）
- 需要历史，因为过程不可逆

## 认知收益

### 1. 分层管理
- 不同类型的知识有不同的生命周期
- 避免所有信息混杂在一起
- 更容易定位需要的信息

### 2. 知识进化
```
执行细节 (task_state) 
    ↓ 提炼
可复用模式 (experience)
    ↓ 结合
环境理解 (environment)
    ↓ 指导
更好的执行
```

### 3. 认知效率
- 减少重复探索
- 加速问题解决
- 保持工作连续性

### 4. 状态压缩
- 三层笔记是三个不同维度的状态压缩
- 不是历史记录，而是当前认知的快照
- 通过状态更新实现知识进化

## 实施建议

1. **开始简单**：先从任务状态笔记开始，逐步建立其他层
2. **保持平衡**：不要过度记录，记关键信息即可
3. **定期回顾**：任务完成后，提炼有价值的内容到经验库
4. **灵活调整**：根据实际需要调整模板和策略

记住：好的笔记系统能让你像拥有了外部大脑，既不遗忘重要信息，又不被细节淹没。