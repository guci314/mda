{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "DebugAgentNotes",
  "description": "调试Agent的结构化笔记schema",
  "type": "object",
  "properties": {
    "session_id": {
      "type": "string",
      "description": "调试会话ID",
      "format": "uuid"
    },
    "created_at": {
      "type": "string",
      "format": "date-time",
      "description": "笔记创建时间"
    },
    "updated_at": {
      "type": "string",
      "format": "date-time",
      "description": "最后更新时间"
    },
    "project_context": {
      "type": "object",
      "description": "项目上下文信息",
      "properties": {
        "project_path": {"type": "string"},
        "project_type": {"type": "string", "enum": ["fastapi", "django", "flask", "other"]},
        "language": {"type": "string"},
        "test_framework": {"type": "string"},
        "entry_point": {"type": "string"},
        "test_command": {"type": "string"}
      }
    },
    "error_patterns": {
      "type": "object",
      "description": "已识别的错误模式库",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "error_type": {
            "type": "string",
            "description": "错误类型（如ModuleNotFoundError）"
          },
          "pattern": {
            "type": "string",
            "description": "错误模式的正则表达式"
          },
          "first_seen": {
            "type": "string",
            "format": "date-time"
          },
          "occurrence_count": {
            "type": "integer",
            "description": "出现次数"
          },
          "locations": {
            "type": "array",
            "description": "错误出现的位置",
            "items": {
              "type": "object",
              "properties": {
                "file": {"type": "string"},
                "line": {"type": "integer"},
                "column": {"type": "integer"}
              }
            }
          },
          "root_cause": {
            "type": "string",
            "description": "分析得出的根本原因"
          },
          "related_errors": {
            "type": "array",
            "description": "相关联的其他错误ID",
            "items": {"type": "string"}
          }
        }
      }
    },
    "fix_attempts": {
      "type": "array",
      "description": "修复尝试记录",
      "items": {
        "type": "object",
        "properties": {
          "attempt_id": {
            "type": "string",
            "description": "修复尝试ID"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "error_id": {
            "type": "string",
            "description": "对应的错误模式ID"
          },
          "strategy": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string",
                "description": "策略名称"
              },
              "category": {
                "type": "string",
                "enum": ["import_fix", "path_fix", "syntax_fix", "logic_fix", "config_fix", "dependency_fix"]
              },
              "description": {
                "type": "string"
              },
              "confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1,
                "description": "策略信心度"
              }
            }
          },
          "actions_taken": {
            "type": "array",
            "description": "具体执行的操作",
            "items": {
              "type": "object",
              "properties": {
                "action_type": {
                  "type": "string",
                  "enum": ["file_edit", "file_create", "file_delete", "command_run", "config_change"]
                },
                "target": {
                  "type": "string",
                  "description": "操作目标（文件路径或命令）"
                },
                "details": {
                  "type": "object",
                  "description": "操作详情",
                  "properties": {
                    "old_content": {"type": "string"},
                    "new_content": {"type": "string"},
                    "line_range": {
                      "type": "object",
                      "properties": {
                        "start": {"type": "integer"},
                        "end": {"type": "integer"}
                      }
                    }
                  }
                }
              }
            }
          },
          "result": {
            "type": "object",
            "properties": {
              "status": {
                "type": "string",
                "enum": ["success", "partial_success", "failed", "made_worse"]
              },
              "test_results": {
                "type": "object",
                "properties": {
                  "total": {"type": "integer"},
                  "passed": {"type": "integer"},
                  "failed": {"type": "integer"},
                  "errors": {"type": "integer"},
                  "skipped": {"type": "integer"},
                  "exit_code": {"type": "integer"}
                }
              },
              "new_errors": {
                "type": "array",
                "description": "修复后出现的新错误",
                "items": {"type": "string"}
              },
              "fixed_errors": {
                "type": "array",
                "description": "成功修复的错误",
                "items": {"type": "string"}
              }
            }
          },
          "lessons_learned": {
            "type": "string",
            "description": "从这次尝试中学到的经验"
          }
        }
      }
    },
    "knowledge_base": {
      "type": "object",
      "description": "积累的知识库",
      "properties": {
        "successful_fixes": {
          "type": "array",
          "description": "成功的修复模式",
          "items": {
            "type": "object",
            "properties": {
              "error_pattern": {"type": "string"},
              "fix_pattern": {"type": "string"},
              "applicable_conditions": {
                "type": "array",
                "items": {"type": "string"}
              },
              "success_rate": {"type": "number"},
              "usage_count": {"type": "integer"}
            }
          }
        },
        "failed_strategies": {
          "type": "array",
          "description": "已知无效的策略",
          "items": {
            "type": "object",
            "properties": {
              "strategy_signature": {"type": "string"},
              "failure_reason": {"type": "string"},
              "conditions": {"type": "array", "items": {"type": "string"}}
            }
          }
        },
        "dependencies_map": {
          "type": "object",
          "description": "错误依赖关系图",
          "additionalProperties": {
            "type": "array",
            "items": {"type": "string"},
            "description": "错误ID -> 依赖的其他错误ID列表"
          }
        }
      }
    },
    "current_state": {
      "type": "object",
      "description": "当前调试状态",
      "properties": {
        "active_errors": {
          "type": "array",
          "items": {"type": "string"},
          "description": "当前活跃的错误ID列表"
        },
        "blocked_errors": {
          "type": "array",
          "description": "被阻塞的错误（依赖其他错误先解决）",
          "items": {
            "type": "object",
            "properties": {
              "error_id": {"type": "string"},
              "blocked_by": {"type": "array", "items": {"type": "string"}}
            }
          }
        },
        "priority_queue": {
          "type": "array",
          "description": "错误修复优先级队列",
          "items": {
            "type": "object",
            "properties": {
              "error_id": {"type": "string"},
              "priority": {"type": "integer"},
              "reason": {"type": "string"}
            }
          }
        },
        "iteration_count": {
          "type": "integer",
          "description": "总迭代次数"
        },
        "stuck_detection": {
          "type": "object",
          "description": "卡住检测",
          "properties": {
            "same_error_count": {"type": "integer"},
            "last_progress_iteration": {"type": "integer"},
            "is_stuck": {"type": "boolean"},
            "suggested_action": {"type": "string"}
          }
        }
      }
    },
    "insights": {
      "type": "array",
      "description": "调试洞察和发现",
      "items": {
        "type": "object",
        "properties": {
          "timestamp": {"type": "string", "format": "date-time"},
          "type": {
            "type": "string",
            "enum": ["pattern_discovered", "root_cause_found", "workaround_found", "limitation_identified"]
          },
          "description": {"type": "string"},
          "confidence": {"type": "number"},
          "evidence": {
            "type": "array",
            "items": {"type": "string"}
          }
        }
      }
    },
    "communication_log": {
      "type": "array",
      "description": "与生成Agent的通信记录",
      "items": {
        "type": "object",
        "properties": {
          "timestamp": {"type": "string", "format": "date-time"},
          "direction": {
            "type": "string",
            "enum": ["to_generator", "from_generator"]
          },
          "message_type": {
            "type": "string",
            "enum": ["error_report", "fix_request", "fix_result", "guidance", "warning"]
          },
          "content": {"type": "string"},
          "metadata": {"type": "object"}
        }
      }
    },
    "statistics": {
      "type": "object",
      "description": "调试统计信息",
      "properties": {
        "total_errors_encountered": {"type": "integer"},
        "errors_fixed": {"type": "integer"},
        "errors_remaining": {"type": "integer"},
        "total_attempts": {"type": "integer"},
        "successful_attempts": {"type": "integer"},
        "average_attempts_per_error": {"type": "number"},
        "time_spent_minutes": {"type": "number"},
        "most_common_error_type": {"type": "string"},
        "most_effective_strategy": {"type": "string"}
      }
    }
  },
  "required": ["session_id", "created_at", "error_patterns", "fix_attempts", "current_state"]
}